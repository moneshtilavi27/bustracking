let Joi,bcrypt,md5,CustomErrorHandler,JwtService,getData;_91e‍.x([["default",()=>_91e‍.o]]);_91e‍.w("joi",[["default",["Joi"],function(v){Joi=v}]]);_91e‍.w("bcrypt",[["default",["bcrypt"],function(v){bcrypt=v}]]);_91e‍.w("md5",[["default",["md5"],function(v){md5=v}]]);_91e‍.w("../../service/index.js",[["CustomErrorHandler",["CustomErrorHandler"],function(v){CustomErrorHandler=v}],["JwtService",["JwtService"],function(v){JwtService=v}]]);_91e‍.w("../../config/index.js",[["getData",["getData"],function(v){getData=v}]]);





const loginController = {
    async login(req, res, next) {
    
        // validation
        const loginSchema = Joi.object({
            phone: Joi.number().required(),
            // password: Joi.string().pattern(new RegExp('^[a-zA-Z0-9]{3,30}$'))
            password: Joi.string().required()
        });

        const { error } = loginSchema.validate(req.body);
        if (error) {
            return next(error);
        }

        let query = "SELECT * FROM `addowner` WHERE `phone`='" + req.body.phone + "';";
        await getData(query, next).then(async (data) => {
            if (data.length <= 0) {
                return next(CustomErrorHandler.wrongCredentials());
            } else {
                // const match = await bcrypt.compare(req.body.password, data[0].password);
                const match = md5(req.body.password) === data[0].password ? true : false;
                delete data[0].password;
                if (!match) {
                    return next(CustomErrorHandler.wrongCredentials());
                } else {
                    const accessToken = JwtService.sign({ _id: data[0].id, role: data[0].role });
                    res.json(
                        {
                            message: "User loged in successfully",
                            accessToken,
                            data: data[0]
                        }
                    )
                }
            }
        });

    }
}



_91e‍.d(loginController);